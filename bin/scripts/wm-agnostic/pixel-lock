#!/usr/bin/env bash

PID=$(pgrep -x -n "Hyprland" || pgrep -x -n "sway" || pgrep -x -n "Xorg")

if [ -z "$PID" ]; then
    echo "No supported compositor found."
    exit 1
fi

# Get the user and User ID associated with that PID
DETECTED_USER=$(ps -o user= -p "$PID")
DETECTED_UID=$(id -u "$DETECTED_USER")

# Detect the session type based on the process name
if pgrep -x "Hyprland" > /dev/null || pgrep -x "sway" > /dev/null; then
    SESSION_TYPE="wayland"
    XDG_SESSION_TYPE="wayland"
    export XDG_RUNTIME_DIR="/run/user/$DETECTED_UID"
    W_DISPLAY=$(find "$XDG_RUNTIME_DIR" -maxdepth 1 -name "wayland-*" -printf "%f\n" | head -n 1)
    export WAYLAND_DISPLAY="${W_DISPLAY:-wayland-1}"
else
    SESSION_TYPE="x11"
    export DISPLAY=":0" # Safe default for X11
fi


run_as_user() {
    if [ "$(id -u)" -eq 0 ]; then
        sudo -u "$DETECTED_USER" \
        XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" \
        WAYLAND_DISPLAY="$WAYLAND_DISPLAY" \
        DISPLAY="$DISPLAY" \
        "$@"
    else
        "$@"
    fi
}

IMAGE="/tmp/screen_locked.png"

if [ "$XDG_SESSION_TYPE" == "wayland" ]; then
    run_as_user grim "$IMAGE"
else
    run_as_user scrot "$IMAGE"
fi

run_as_user magick "$IMAGE" -scale 10% -scale 1000% "$IMAGE"

if [ "$XDG_SESSION_TYPE" == "wayland" ]; then
    run_as_user swaylock -f -i "$IMAGE"
else
    run_as_user i3lock -i "$IMAGE" -k -f -e
fi

rm "$IMAGE"
